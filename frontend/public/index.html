<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mikel Coffee - Çalışan Sistemi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #F5E6D3;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            background: #8B4513;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin-bottom: 0;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            margin: 0 auto 10px;
            background: white;
            display: block;
        }
        
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 4px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #8B4513;
            color: white;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: #fafafa;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #8B4513;
            background: white;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #654321;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .register-fields {
            display: none;
        }
        
        .register-fields.active {
            display: block;
        }
        
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .position-list {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
        }
        
        .position-item {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .position-item:hover {
            background: #f8f9fa;
        }
        
        .position-item:last-child {
            border-bottom: none;
        }
        
        .position-item.selected {
            background: #8B4513;
            color: white;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://customer-assets.emergentagent.com/job_0f64345d-2f6b-41c8-af15-208e01ade896/artifacts/fwptedkg_M%C4%B0KEL%20LOGOSU.png" 
                 alt="Mikel Coffee" class="logo">
            <h1>Mikel Coffee</h1>
            <p>Çalışan Sistemi</p>
        </div>
        
        <div class="form-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('login')">Giriş Yap</button>
                <button class="tab" onclick="switchTab('register')">Kayıt Ol</button>
            </div>
            
            <form id="authForm">
                <div class="register-fields">
                    <div class="form-group">
                        <label>Adınız</label>
                        <input type="text" class="form-control" id="name" placeholder="Adınız">
                    </div>
                    <div class="form-group">
                        <label>Soyadınız</label>
                        <input type="text" class="form-control" id="surname" placeholder="Soyadınız">
                    </div>
                    <div class="form-group">
                        <label>Mağaza</label>
                        <input type="text" class="form-control" id="store" placeholder="Hangi mağaza (örn: Kadıköy, Merkez)">
                    </div>
                    <div class="form-group">
                        <label>Pozisyon</label>
                        <input type="text" class="form-control" id="position" placeholder="Pozisyonunuzu seçin" readonly onclick="togglePositions()">
                        <div class="position-list" id="positionList" style="display:none;">
                            <div class="position-item" onclick="selectPosition('servis personeli')">Servis Personeli</div>
                            <div class="position-item" onclick="selectPosition('barista')">Barista</div>
                            <div class="position-item" onclick="selectPosition('supervizer')">Supervizer</div>
                            <div class="position-item" onclick="selectPosition('müdür yardımcısı')">Müdür Yardımcısı</div>
                            <div class="position-item" onclick="selectPosition('mağaza müdürü')">Mağaza Müdürü</div>
                            <div class="position-item" onclick="selectPosition('trainer')">Trainer</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" class="form-control" id="email" placeholder="E-posta adresiniz" required>
                </div>
                
                <div class="form-group">
                    <label>Şifre</label>
                    <input type="password" class="form-control" id="password" placeholder="Şifreniz" required>
                </div>
                
                <button type="submit" class="btn" id="submitBtn">Giriş Yap</button>
                <div id="message"></div>
            </form>
        </div>
    </div>

    <script>
        let isLoginMode = true;
        let selectedPosition = '';

        function switchTab(mode) {
            isLoginMode = (mode === 'login');
            const tabs = document.querySelectorAll('.tab');
            const registerFields = document.querySelector('.register-fields');
            const submitBtn = document.getElementById('submitBtn');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (isLoginMode) {
                registerFields.classList.remove('active');
                submitBtn.textContent = 'Giriş Yap';
            } else {
                registerFields.classList.add('active');
                submitBtn.textContent = 'Kayıt Ol';
            }
        }

        function togglePositions() {
            const positionList = document.getElementById('positionList');
            positionList.style.display = positionList.style.display === 'none' ? 'block' : 'none';
        }

        function selectPosition(position) {
            selectedPosition = position;
            document.getElementById('position').value = position.charAt(0).toUpperCase() + position.slice(1);
            document.getElementById('positionList').style.display = 'none';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!email || !password) {
                showMessage('E-posta ve şifre alanları zorunludur', 'error');
                return;
            }
            
            if (!isLoginMode) {
                const name = document.getElementById('name').value.trim();
                const surname = document.getElementById('surname').value.trim();
                const store = document.getElementById('store').value.trim();
                
                if (!name || !surname || !selectedPosition || !store) {
                    showMessage('Tüm alanları doldurunuz', 'error');
                    return;
                }
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'İşleniyor...';
            
            try {
                const endpoint = isLoginMode ? 'login' : 'register';
                const body = isLoginMode 
                    ? { email: email.toLowerCase(), password }
                    : {
                        email: email.toLowerCase(),
                        password,
                        name: document.getElementById('name').value.trim(),
                        surname: document.getElementById('surname').value.trim(),
                        position: selectedPosition,
                        store: document.getElementById('store').value.trim()
                    };

                const response = await fetch(`https://employee-register-3.preview.emergentagent.com/api/auth/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('auth_token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    showMessage(isLoginMode 
                        ? `Hoş geldiniz, ${data.user.name} ${data.user.surname}!`
                        : `Kayıt başarılı! Sicil numaranız: ${data.user.employee_id}`, 'success');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage(data.detail || 'Bir hata oluştu', 'error');
                }
            } catch (error) {
                showMessage('Bağlantı hatası. Lütfen tekrar deneyin.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isLoginMode ? 'Giriş Yap' : 'Kayıt Ol';
            }
        });

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }

        // Check if user is already logged in
        window.onload = function() {
            const token = localStorage.getItem('auth_token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (token && user.name) {
                loadDashboard(user, token);
            }
        };

        function loadDashboard(user, token) {
            // Load announcements
            loadAnnouncements(token);
            
            document.body.innerHTML = `
                <div class="container">
                    <div class="header">
                        <img src="https://customer-assets.emergentagent.com/job_0f64345d-2f6b-41c8-af15-208e01ade896/artifacts/fwptedkg_M%C4%B0KEL%20LOGOSU.png" 
                             alt="Mikel Coffee" class="logo">
                        <h1>Mikel Coffee</h1>
                        <button onclick="logout()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">Çıkış</button>
                    </div>
                    
                    <div class="dashboard">
                        <div class="welcome-card">
                            <h2>Hoş Geldiniz, ${user.name} ${user.surname}!</h2>
                            <div class="user-info">
                                <p><strong>Sicil No:</strong> ${user.employee_id}</p>
                                <p><strong>Pozisyon:</strong> ${user.position?.charAt(0).toUpperCase() + user.position?.slice(1)}</p>
                                <p><strong>Mağaza:</strong> ${user.store || 'Bilinmiyor'}</p>
                                <p><strong>E-posta:</strong> ${user.email}</p>
                                ${user.is_admin ? '<span class="badge admin-badge">YÖNETİCİ</span>' : ''}
                                ${user.special_role ? '<span class="badge edu-badge">EĞİTİM DEPARTMANI</span>' : ''}
                            </div>
                        </div>

                        <div class="menu-grid">
                            <div class="menu-item" onclick="showAnnouncements()">
                                <h3>📢 Duyurular</h3>
                                <p>Şirket haberlerini görün</p>
                                <div id="urgentIndicator" style="display: none;" class="urgent-indicator">🔴 ACİL</div>
                            </div>
                            
                            <div class="menu-item" onclick="showExamResults()">
                                <h3>📊 Sınav Sonuçları</h3>
                                <p>Performans sonuçlarınız</p>
                            </div>
                            
                            ${(user.position === 'barista' || user.position === 'supervizer') ? `
                            <div class="menu-item management-exam" onclick="showManagementExam()">
                                <h3>🎯 Yöneticilik Sınavı</h3>
                                <p>Karriyere ilerle</p>
                            </div>
                            ` : ''}
                            
                            ${(user.position === 'trainer' || user.special_role === 'eğitim departmanı' || user.is_admin) ? `
                            <div class="menu-item trainer-item" onclick="showCreateAnnouncement()">
                                <h3>📝 Duyuru Paylaş</h3>
                                <p>Yeni duyuru oluştur</p>
                            </div>
                            
                            <div class="menu-item trainer-item" onclick="showExamEntry()">
                                <h3>📋 Sınav Sonucu Gir</h3>
                                <p>Çalışan değerlendirmesi</p>
                            </div>
                            ` : ''}
                            
                            ${user.is_admin ? `
                            <div class="menu-item admin-item" onclick="showAdminPanel()">
                                <h3>⚙️ Yönetici Paneli</h3>
                                <p>Sistem yönetimi</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div id="modalOverlay" class="modal-overlay" style="display: none;" onclick="closeModal()">
                            <div class="modal-content" onclick="event.stopPropagation()">
                                <div class="modal-header">
                                    <h3 id="modalTitle"></h3>
                                    <button onclick="closeModal()" class="close-btn">✕</button>
                                </div>
                                <div id="modalBody" class="modal-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    .header { position: relative; }
                    
                    .dashboard {
                        max-width: 400px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    
                    .welcome-card {
                        background: white;
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .welcome-card h2 {
                        color: #8B4513;
                        margin-bottom: 16px;
                        font-size: 20px;
                    }
                    
                    .user-info p {
                        margin: 8px 0;
                        color: #666;
                    }
                    
                    .badge {
                        display: inline-block;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: bold;
                        margin: 8px 4px 0 0;
                    }
                    
                    .admin-badge {
                        background: #FF6B6B;
                        color: white;
                    }
                    
                    .edu-badge {
                        background: #4ECDC4;
                        color: white;
                    }
                    
                    .menu-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    
                    .menu-item {
                        background: white;
                        padding: 20px;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        position: relative;
                    }
                    
                    .menu-item:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }
                    
                    .menu-item h3 {
                        margin: 0 0 8px 0;
                        color: #333;
                        font-size: 18px;
                    }
                    
                    .menu-item p {
                        margin: 0;
                        color: #666;
                        font-size: 14px;
                    }
                    
                    .management-exam {
                        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
                        border-left: 4px solid #2196F3;
                    }
                    
                    .trainer-item {
                        background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
                        border-left: 4px solid #4CAF50;
                    }
                    
                    .admin-item {
                        background: linear-gradient(135deg, #FFF3E0 0%, #FFCC02 100%);
                        border-left: 4px solid #FF9800;
                    }
                    
                    .urgent-indicator {
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: #FF4444;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 10px;
                        font-weight: bold;
                    }
                    
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    
                    .modal-content {
                        background: white;
                        border-radius: 12px;
                        width: 100%;
                        max-width: 400px;
                        max-height: 90vh;
                        overflow-y: auto;
                    }
                    
                    .modal-header {
                        background: #8B4513;
                        color: white;
                        padding: 16px 20px;
                        border-radius: 12px 12px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .modal-header h3 {
                        margin: 0;
                    }
                    
                    .close-btn {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 4px;
                        border-radius: 4px;
                        background: rgba(255,255,255,0.2);
                    }
                    
                    .modal-body {
                        padding: 20px;
                    }
                    
                    .announcement-card {
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 16px;
                        margin-bottom: 12px;
                        border-left: 4px solid #8B4513;
                    }
                    
                    .announcement-card.urgent {
                        border-left-color: #FF4444;
                        background: #FFF5F5;
                    }
                    
                    .announcement-card h4 {
                        margin: 0 0 8px 0;
                        color: #333;
                    }
                    
                    .announcement-card p {
                        margin: 0 0 8px 0;
                        color: #666;
                        line-height: 1.5;
                    }
                    
                    .announcement-meta {
                        font-size: 12px;
                        color: #999;
                        border-top: 1px solid #eee;
                        padding-top: 8px;
                        display: flex;
                        justify-content: space-between;
                    }
                    
                    .form-group {
                        margin-bottom: 16px;
                    }
                    
                    .form-group label {
                        display: block;
                        margin-bottom: 6px;
                        font-weight: 500;
                    }
                    
                    textarea {
                        width: 100%;
                        padding: 12px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-family: inherit;
                        resize: vertical;
                        min-height: 100px;
                    }
                    
                    .checkbox-group {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 12px;
                        background: #f8f9fa;
                        border-radius: 8px;
                    }
                </style>
            `;
        }

        let announcements = [];
        
        async function loadAnnouncements(token) {
            try {
                const response = await fetch('https://employee-register-3.preview.emergentagent.com/api/announcements', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    announcements = await response.json();
                    // Check for urgent announcements
                    const hasUrgent = announcements.some(a => a.is_urgent);
                    if (hasUrgent) {
                        setTimeout(() => {
                            const indicator = document.getElementById('urgentIndicator');
                            if (indicator) indicator.style.display = 'block';
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }
        
        function showAnnouncements() {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = '📢 Duyurular';
            
            if (announcements.length === 0) {
                modalBody.innerHTML = '<p style="text-align: center; color: #666;">Henüz duyuru bulunmuyor</p>';
            } else {
                modalBody.innerHTML = announcements.map(announcement => `
                    <div class="announcement-card ${announcement.is_urgent ? 'urgent' : ''}">
                        ${announcement.is_urgent ? '<div style="color: #FF4444; font-weight: bold; font-size: 12px; margin-bottom: 8px;">🔴 ACİL DUYURU</div>' : ''}
                        <h4>${announcement.title}</h4>
                        <p>${announcement.content}</p>
                        <div class="announcement-meta">
                            <span>📝 ${announcement.created_by}</span>
                            <span>📅 ${new Date(announcement.created_at).toLocaleDateString('tr-TR')}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        function showExamResults() {
            document.getElementById('modalTitle').textContent = '📊 Sınav Sonuçları';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p>Sınav sonuçları özelliği yakında eklenecek</p>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        function showManagementExam() {
            document.getElementById('modalTitle').textContent = '🎯 Yöneticilik Sınavı';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h4>Yöneticilik Sınavına Hoş Geldiniz</h4>
                    <p>Bu sınav sadece Barista ve Supervizer pozisyonundaki çalışanlar için açıktır.</p>
                    <p>Sınav özelliği yakında aktif olacak.</p>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        function showCreateAnnouncement() {
            document.getElementById('modalTitle').textContent = '📝 Yeni Duyuru';
            document.getElementById('modalBody').innerHTML = `
                <form id="announcementForm">
                    <div class="form-group">
                        <label>Başlık *</label>
                        <input type="text" class="form-control" id="annTitle" placeholder="Duyuru başlığı" maxlength="100" required>
                    </div>
                    <div class="form-group">
                        <label>İçerik *</label>
                        <textarea class="form-control" id="annContent" placeholder="Duyuru içeriği..." maxlength="500" required></textarea>
                        <small style="color: #666;">Max 500 karakter</small>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="isUrgent">
                            <label for="isUrgent">🔴 Acil Duyuru</label>
                        </div>
                    </div>
                    <button type="submit" class="btn">📢 Duyuru Yayınla</button>
                </form>
            `;
            
            document.getElementById('announcementForm').addEventListener('submit', createAnnouncement);
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        async function createAnnouncement(e) {
            e.preventDefault();
            
            const title = document.getElementById('annTitle').value.trim();
            const content = document.getElementById('annContent').value.trim();
            const isUrgent = document.getElementById('isUrgent').checked;
            const token = localStorage.getItem('auth_token');
            
            if (!title || !content) {
                alert('Başlık ve içerik alanları zorunludur');
                return;
            }
            
            try {
                const response = await fetch('https://employee-register-3.preview.emergentagent.com/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        is_urgent: isUrgent
                    })
                });
                
                if (response.ok) {
                    alert('Duyuru başarıyla oluşturuldu!');
                    closeModal();
                    // Reload announcements
                    await loadAnnouncements(token);
                } else {
                    const error = await response.json();
                    alert('Hata: ' + (error.detail || 'Duyuru oluşturulamadı'));
                }
            } catch (error) {
                alert('Bağlantı hatası');
            }
        }
        
        function showExamEntry() {
            document.getElementById('modalTitle').textContent = '📋 Sınav Sonucu Gir';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p>Sınav sonucu girme özelliği yakında eklenecek</p>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        function showAdminPanel() {
            document.getElementById('modalTitle').textContent = '⚙️ Çalışan Yönetimi';
            document.getElementById('modalBody').innerHTML = `
                <div id="userManagement">
                    <div style="margin-bottom: 20px;">
                        <button onclick="loadAllUsers()" class="btn" style="width: 100%; margin-bottom: 10px;">👥 Tüm Çalışanları Görüntüle</button>
                    </div>
                    <div id="usersList"></div>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        async function loadAllUsers() {
            const token = localStorage.getItem('auth_token');
            const usersList = document.getElementById('usersList');
            
            usersList.innerHTML = '<div style="text-align: center; padding: 20px;">Yükleniyor...</div>';
            
            try {
                const response = await fetch('https://employee-register-3.preview.emergentagent.com/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else {
                    const error = await response.json();
                    usersList.innerHTML = `<div style="color: red; text-align: center;">Hata: ${error.detail}</div>`;
                }
            } catch (error) {
                usersList.innerHTML = `<div style="color: red; text-align: center;">Bağlantı hatası</div>`;
            }
        }
        
        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            const currentUser = JSON.parse(localStorage.getItem('user'));
            
            usersList.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4 style="margin-bottom: 15px;">📋 Kayıtlı Çalışanlar (${users.length})</h4>
                    ${users.map(user => `
                        <div class="user-card" style="background: #f8f9fa; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${user.is_admin ? '#FF6B6B' : user.special_role ? '#4ECDC4' : '#8B4513'};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 8px 0; color: #333;">${user.name} ${user.surname}</h5>
                                    <div style="font-size: 14px; color: #666;">
                                        <div>🏷️ Sicil: ${user.employee_id}</div>
                                        <div>📧 ${user.email}</div>
                                        <div>💼 ${user.position?.charAt(0).toUpperCase() + user.position?.slice(1)}</div>
                                        <div>🏪 ${user.store || 'Bilinmiyor'}</div>
                                        ${user.is_admin ? '<div style="color: #FF6B6B; font-weight: bold;">👑 YÖNETİCİ</div>' : ''}
                                        ${user.special_role ? '<div style="color: #4ECDC4; font-weight: bold;">🎓 EĞİTİM DEPARTMANI</div>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <button onclick="editUser('${user._id}')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">✏️ Düzenle</button>
                                    ${(currentUser.is_admin && user._id !== currentUser._id) ? `<button onclick="deleteUser('${user._id}', '${user.name} ${user.surname}')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">🗑️ Sil</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        let currentEditingUser = null;
        
        async function editUser(userId) {
            const token = localStorage.getItem('auth_token');
            const currentUser = JSON.parse(localStorage.getItem('user'));
            
            try {
                // Find user data from already loaded users or fetch again
                const response = await fetch('https://employee-register-3.preview.emergentagent.com/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const user = users.find(u => u._id === userId);
                    
                    if (user) {
                        currentEditingUser = user;
                        showEditModal(user, currentUser);
                    }
                }
            } catch (error) {
                alert('Kullanıcı bilgileri yüklenirken hata oluştu');
            }
        }
        
        function showEditModal(user, currentUser) {
            document.getElementById('modalTitle').textContent = `✏️ ${user.name} ${user.surname} - Düzenle`;
            document.getElementById('modalBody').innerHTML = `
                <form id="editUserForm">
                    <div class="form-group">
                        <label>Ad *</label>
                        <input type="text" class="form-control" id="editName" value="${user.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Soyad *</label>
                        <input type="text" class="form-control" id="editSurname" value="${user.surname}" required>
                    </div>
                    <div class="form-group">
                        <label>E-posta *</label>
                        <input type="email" class="form-control" id="editEmail" value="${user.email}" required>
                    </div>
                    <div class="form-group">
                        <label>Pozisyon *</label>
                        <select class="form-control" id="editPosition" required>
                            <option value="servis personeli" ${user.position === 'servis personeli' ? 'selected' : ''}>Servis Personeli</option>
                            <option value="barista" ${user.position === 'barista' ? 'selected' : ''}>Barista</option>
                            <option value="supervizer" ${user.position === 'supervizer' ? 'selected' : ''}>Supervizer</option>
                            <option value="müdür yardımcısı" ${user.position === 'müdür yardımcısı' ? 'selected' : ''}>Müdür Yardımcısı</option>
                            <option value="mağaza müdürü" ${user.position === 'mağaza müdürü' ? 'selected' : ''}>Mağaza Müdürü</option>
                            <option value="trainer" ${user.position === 'trainer' ? 'selected' : ''}>Trainer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mağaza *</label>
                        <input type="text" class="form-control" id="editStore" value="${user.store || ''}" required>
                    </div>
                    ${currentUser.is_admin ? `
                    <div class="form-group">
                        <label>Özel Rol (Sadece Admin)</label>
                        <select class="form-control" id="editSpecialRole">
                            <option value="">Yok</option>
                            <option value="eğitim departmanı" ${user.special_role === 'eğitim departmanı' ? 'selected' : ''}>Eğitim Departmanı</option>
                        </select>
                    </div>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn" style="flex: 1;">💾 Kaydet</button>
                        <button type="button" onclick="loadAllUsers()" class="btn" style="flex: 1; background: #6c757d;">🔙 Geri</button>
                    </div>
                </form>
            `;
            
            document.getElementById('editUserForm').addEventListener('submit', saveUserChanges);
        }
        
        async function saveUserChanges(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('auth_token');
            const currentUser = JSON.parse(localStorage.getItem('user'));
            
            const updates = {
                name: document.getElementById('editName').value.trim(),
                surname: document.getElementById('editSurname').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                position: document.getElementById('editPosition').value,
                store: document.getElementById('editStore').value.trim()
            };
            
            if (currentUser.is_admin) {
                const specialRole = document.getElementById('editSpecialRole').value;
                updates.special_role = specialRole || null;
            }
            
            try {
                const response = await fetch(`https://employee-register-3.preview.emergentagent.com/api/users/${currentEditingUser._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (response.ok) {
                    alert('Kullanıcı bilgileri başarıyla güncellendi!');
                    loadAllUsers(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('Hata: ' + (error.detail || 'Güncelleme başarısız'));
                }
            } catch (error) {
                alert('Bağlantı hatası');
            }
        }
        
        async function deleteUser(userId, userName) {
            if (!confirm(`${userName} kullanıcısını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch(`https://employee-register-3.preview.emergentagent.com/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Kullanıcı başarıyla silindi');
                    loadAllUsers(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('Hata: ' + (error.detail || 'Silme işlemi başarısız'));
                }
            } catch (error) {
                alert('Bağlantı hatası');
            }
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            window.location.reload();
        }
    </script>
</body>
</html>